---
title: "vmProcessing_Norway"
output: html_document
date: "2022-11-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)

# import functions
source('functions_visionProcessing_and_threshEstimation.R')
```

## read in online data

this chunk sets the working directory and then imports the seperate data files for the demographics questionaire, the combined vision tests and the debrief.
the debrief is extracted to allow the prize to be given.

```{r online data}
setwd('../data/onlineNorway')

demoOnline <- read.csv('./data_exp_102468-v2_questionnaire-gb9f.csv')
emailOnline <- read.csv('./data_exp_102468-v2_questionnaire-mq5s.csv')

# read in all task files and combine into a single DF for vision tests
# use this once all files have data in
#files = list.files(pattern="*task*")
bigFiles <- file.info(list.files(pattern="*task*")) %>%
  filter(size > 2000)
files <- rownames(bigFiles)
#files = 
visionTestsOnline = do.call(rbind, lapply(files, fread))
rm(files)
rm(bigFiles)

visionTestsOnline <- as.data.frame(unclass(visionTestsOnline))
```


Here we extract the participant id information:
letter of first name, middle name and place of birth + age in months

this will later be matched to the participant.private.id and the experiment.id to uniquely identify their data

replace 'I do not have a middle name' with ''
this will be used if we need to double chekc piblic id

Participant 30 got an acq wrong in the lab and wrong in the online session so their data will be excluded. Their perforance was also sig worse online with sig shorter response times.
```{r online demographics}
demoOnline <- demoOnline %>%
  mutate(middleName = case_when(
    middleName == "I do not have a middle name" ~ '',
    TRUE ~ middleName
  ))


idOnline <- demoOnline %>%
  filter(Event.Index != 'END OF FILE') %>%
  mutate(id = paste(firstName, middleName, birthPlace, dob.inmonths, sep = ''))%>%
  select(id, Participant.Private.ID, Experiment.ID)

```



we will now remove rows that do not include useful information 
``` {r online row clean}
visionTestsOnline <- visionTestsOnline %>%
  filter(Zone.Type == 'response_text_entry')%>%
  rename(id = Participant.Public.ID)

```

seperate cs, va and acq data
```{r online seperate tasks}
acqOnline <- visionTestsOnline %>%
  filter(display == 'ACQ')
csOnline <- visionTestsOnline %>%
  filter(display == 'cs')
vaOnline <- visionTestsOnline %>%
  filter(display == 'va')

```

Estimate va threshold
done in a similar way to opticians charts e.g. a completely correct line takes 0.1 logMAR off total score.
this can be done by totaling the percentage correct, dividing by 10 and taking this fromt he upper limit of the test, in this case 1.1 logMAR
```{r online va estimation}


vaShortOnline <- shortenVA(vaOnline)
vaSummOnline <- summShortVA(vaShortOnline)
vaThreshOnline <- threshVAround(vaSummOnline, 'Online')

head(vaThreshOnline)
```

Estimate CS threshold, this is the lowest value that participant scores 0.5 or higher for perc correct

check the calculation of logCS against pelli robinson chart in lab.
```{r online cs estimation}
csShortOnline <- shortenCS(csOnline)

csSummOnline <- summShortCS(csShortOnline) 

csThreshOnline <- threshCS(csSummOnline, 'Online') 

head(csThreshOnline)
  
```

```   {r plot change about threshold}

ppList <- unique(csSummOnline$id)

df <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 2*length(ppList),
                          ncol = 3))


cols <- c("id",
          "thresh", "threshPerc")

colnames(df) <- cols

rm(cols)

for (pp in ppList){
  x <- csSummOnline %>%
    filter(id == pp)
  
  threshInd <- min(which(x$percCorrect > .5))
  thresh <- x$contrast[threshInd]
  threshPerc <- x$percCorrect[threshInd]
  
  subThresh <- thresh - 1
  subThreshInd <- which(x$contrast == subThresh)
  subThreshPerc <- x$percCorrect[subThreshInd]

  
  df[which(ppList == pp), 1]<-x$id[1]
  df[which(ppList == pp)+length(ppList), 1]<-x$id[1]
  
  df[which(ppList == pp), 2]<-x$contrast[threshInd]
  df[which(ppList == pp), 3] <-x$percCorrect[threshInd]
  
  df[which(ppList == pp)+length(ppList), 2]<- subThresh
  
  if (subThresh == 0){
    df[which(ppList == pp)+length(ppList), 3] <- 0
  }else{
    df[which(ppList == pp)+length(ppList), 3] <- subThreshPerc
  }
  
}

df$id <- as.factor(df$id)
ggplot(df%>%filter(thresh != 0), aes(x = thresh, y = threshPerc, color = id))+
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 0.5)#+ 
  #scale_x_continuous(trans='log10') 

```
```{r perc lim}
percLim <- .25
```
```{r extract data from model}
dfThresh <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(ppList),
                          ncol = 5))


cols <- c("id",
          "thresh", "threshPerc",
          "subThresh", "subThreshPerc")

colnames(dfThresh) <- cols

rm(cols)

precThresh <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(ppList),
                          ncol = 2))

for (pp in ppList){
  x <- csSummOnline %>%
    filter(id == pp)
  
  threshInd <- min(which(x$percCorrect > percLim))
  thresh <- x$contrast[threshInd]
  threshPerc <- x$percCorrect[threshInd]
  
  if (thresh == 1){
    subThresh <- 0.0 
  }else{
    subThresh <- thresh - 1 
  }
  
  
  
  subThreshInd <- which(x$contrast == subThresh)
  
  if (subThresh == 0){
    subThreshPerc <- 0
  }else{
   subThreshPerc<- x$percCorrect[subThreshInd] 
  }

  percList <- seq(from = subThreshPerc, to = threshPerc, by = 0.01)
  threshList <- seq(from = subThresh, to = thresh, length.out = length(percList))

  interDF <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(percList),
                          ncol = 3))
  cols <- c('id', 'percCorrect', 'thresh')
  interDF[1] <- pp
  interDF[2] <- percList
  interDF[3] <- threshList
  
  colnames(interDF) <- cols
  
  rm(cols)
  
  interDF <- interDF %>%
    filter(percCorrect > percLim)
  
  outDF <- interDF[1,]
  
  
  
  #colnames(interDF) <- cols
  
  cols <- c('id', 'thresh')
  colnames(precThresh) <- cols
  rm(cols)
  precThresh[which(ppList == pp), 1]<-outDF[1]
  precThresh[which(ppList == pp), 2]<-outDF[3]
  
}

precThresh <- precThresh %>%
  group_by(id)%>%
  mutate(thresh = case_when(
    thresh < 1 ~ 1,
    TRUE ~ thresh
  ))%>%
  mutate(thresh = round(thresh, 2))%>%
  mutate(cs = 2 + log10(1/thresh))

precThresh <- precThresh %>%
  rename(csOnlinePrec = cs) %>%
  select(-thresh)
```

merge data frames together
```{r online df merge}
onlineDF <- merge(csThreshOnline, vaThreshOnline, on = 'id')
onlineDF <- merge(onlineDF, precThresh, on = 'id')

head(onlineDF)

```

# let's import the lab collected data for the online tests
```{r lab data}
setwd('../data/labNorway')

demoLab <- read.csv('./data_exp_102467-v5_questionnaire-u67w.csv')
emailLab <- read.csv('./data_exp_102467-v5_questionnaire-mq5s.csv')

# create list of chart files
chartFiles <- c("data_exp_102467-v5_task-fwvh.csv", "data_exp_102467-v5_task-ysdh.csv")
preTest <- 'data_exp_102467-v5_task-4atu.csv'

# read in all task files and combine into a single DF for vision tests
# use this once all files have data in
#files = list.files(pattern="*task*")
bigFiles <- file.info(list.files(pattern="*task*")) %>%
  filter(size > 2000)

bigFiles$name <- rownames(bigFiles) 

bigFiles <- bigFiles %>%
  filter(!name %in% chartFiles)%>%
  filter(name != preTest)
files <- row.names(bigFiles)


#files = 
# why is this not working?!
visionTestsLab = do.call(rbind, lapply(files, fread))
rm(files)
rm(bigFiles)

visionTestsLab <- as.data.frame(unclass(visionTestsLab))

```

```{r merge v4 files}
setwd('../data/labNorway/v4')



demoLab_v4 <- read.csv('./data_exp_102467-v4_questionnaire-u67w.csv')
emailLab_v4 <- read.csv('./data_exp_102467-v4_questionnaire-mq5s.csv')


# create list of chart files
chartFiles_v4 <- c("data_exp_102467-v4_task-fwvh.csv", "data_exp_102467-v4_task-ysdh.csv")
preTest_v4 <- 'data_exp_102467-v4_task-4atu.csv'

# read in all task files and combine into a single DF for vision tests
# use this once all files have data in
#files = list.files(pattern="*task*")
bigFiles_v4 <- file.info(list.files(pattern="*task*")) %>%
  filter(size > 2000)

bigFiles_v4$name <- rownames(bigFiles_v4)

bigFiles_v4 <- bigFiles_v4 %>%
  filter(!name %in% chartFiles_v4)%>%
  filter(name != preTest_v4)
files_v4 <- row.names(bigFiles_v4)


visionTestsLab_v4 = do.call(rbind, lapply(files_v4, fread))
rm(files_v4)
rm(bigFiles_v4)

visionTestsLab_v4 <- as.data.frame(unclass(visionTestsLab_v4))
```
```{r bind v4 and v5}
visionTestsLab <- rbind(visionTestsLab, visionTestsLab_v4)
```

Here we extract the participant id information:
letter of first name, middle name and place of birth + age in months

this will later be matched to the participant.private.id and the experiment.id to uniquely identify their data
```{r lab demographics}
demoLab <- demoLab %>%
  mutate(middleName = case_when(
    middleName == "I do not have a middle name" ~ '',
    TRUE ~ middleName
  ))

idLab <- demoLab%>%
  filter(Event.Index != 'END OF FILE') %>%
  mutate(id = paste(firstName, middleName, birthPlace, dob.inmonths, sep = ''))%>%
  select(id, Participant.Private.ID, Experiment.ID)

```


we will now remove rows that do not include useful information 
``` {r lab row clean}
visionTestsLab <- visionTestsLab %>%
  filter(Zone.Type == 'response_text_entry')%>%
  rename(id = Participant.Public.ID)

```

seperate cs, va and acq data
```{r lab seperate tasks}
acqLab <- visionTestsLab %>%
  filter(display == 'ACQ')
csLab <- visionTestsLab %>%
  filter(display == 'cs')
vaLab <- visionTestsLab %>%
  filter(display == 'va')

```
Estimate va threshold
done in a similar way to opticians charts e.g. a completely correct line takes 0.1 logMAR off total score.
this can be done by totaling the percentage correct, dividing by 10 and taking this fromt he upper limit of the test, in this case 1.1 logMAR
```{r lab va estimation}
vaShortLab <- shortenVA(vaLab)

vaSummLab <- summShortVA(vaShortLab)

vaThreshLab <- threshVAround(vaSummLab, 'Lab')

head(vaThreshLab)
```
Estimate CS threshold, this is the lowest value that participant scores 0.5 or higher for perc correct

check the calculation of logCS against pelli robinson chart in lab.
```{r lab cs estimation}
csShortLab <- shortenCS(csLab)

csSummLab <- summShortCS(csShortLab)
csThreshLab <- threshCS(csSummLab, 'Lab')

head(csThreshLab)
  
```

```{r extract data from model lab}
ppListLab <- unique(csSummLab$id)

dfThreshLab <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(ppList),
                          ncol = 5))


cols <- c("id",
          "thresh", "threshPerc",
          "subThresh", "subThreshPerc")

colnames(dfThreshLab) <- cols

rm(cols)

precThreshLab <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(ppListLab),
                          ncol = 2))

for (pp in ppListLab){
  x <- csSummLab %>%
    filter(id == pp)
  
  threshInd <- min(which(x$percCorrect > percLim))
  thresh <- x$contrast[threshInd]
  threshPerc <- x$percCorrect[threshInd]
  
  #print(thresh)
  
  if (thresh == 1){
    subThresh <- 0.0 
  }else{
    subThresh <- thresh - 1 
  }
  
  
  
  subThreshInd <- which(x$contrast == subThresh)
  
  if (subThresh == 0){
    subThreshPerc <- 0
  }else{
   subThreshPerc<- x$percCorrect[subThreshInd] 
  }

  percList <- seq(from = subThreshPerc, to = threshPerc, by = 0.01)
  threshList <- seq(from = subThresh, to = thresh, length.out = length(percList))

  interDF <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = length(percList),
                          ncol = 3))
  cols <- c('id', 'percCorrect', 'thresh')
  interDF[1] <- pp
  interDF[2] <- percList
  interDF[3] <- threshList
  
  colnames(interDF) <- cols
  
  rm(cols)
  
  interDF <- interDF %>%
    filter(percCorrect > percLim)
  
  outDF <- interDF[1,]
  
  
  
  #colnames(interDF) <- cols
  #### mistake in this bit
  cols <- c('id', 'thresh')
  colnames(precThreshLab) <- cols
  rm(cols)
  precThreshLab[which(ppListLab == pp), 1]<-outDF[1]
  precThreshLab[which(ppListLab == pp), 2]<-outDF[3]
  
}

precThreshLab <- precThreshLab %>%
  group_by(id)%>%
  mutate(thresh = case_when(
    thresh < 1 ~ 1,
    TRUE ~ thresh
  ))%>%
  mutate(thresh = round(thresh, 2))%>%
  mutate(cs = 2 + log10(1/thresh))

precThreshLab <- precThreshLab %>%
  rename(csLabPrec = cs) %>%
  select(-thresh)
```

merge data frames together
```{r online df merge}
onlineDF <- merge(csThreshOnline, vaThreshOnline, on = 'id')
onlineDF <- merge(onlineDF, precThresh, on = 'id')

head(onlineDF)

```

merge data frames together
```{r lab df merge}
labDF <- merge(csThreshLab, vaThreshLab, on = 'id')
labDF <- merge(labDF, precThreshLab, on = 'id')

head(labDF)

```
```{r merge lab n online df}
computerDF <- merge(onlineDF, labDF, on = 'id', all = TRUE)

head(computerDF)

```

```{r replace incorrect id cols}

computerDF$id <- replace(computerDF$id, computerDF$id == 'kml259', 'kml258')
computerDF$id <- replace(computerDF$id, computerDF$id == 'slk231', 'slk230')

col_order <- c("id",
               "csOnline","csLab",
                "csOnlineRT", "csLabRT", 
               "csOnlinePrec", "csLabPrec",
               "vaOnline", "vaLab" , 
               "vaOnlineRT", "vaLabRT")

   
computerDF <- computerDF[, col_order]

#DF
idVals <- unique(computerDF$id)#
testRows <- length(computerDF$id)
testCols <- ncol(computerDF)

DF2 = data.frame(matrix(NA,    # Create empty data frame
                          nrow = testRows,
                          ncol = testCols))
colnames(DF2) <- colnames(computerDF)

for (val in idVals)
{
  
  if (nrow(subset(computerDF, id == val))>1)
  {
    x <- computerDF %>%
      filter(id == val)%>%
      group_by(id)%>%
      summarise(across(starts_with(c('cs', 'va')), ~sum(., na.rm = TRUE)))

    DF2[which(computerDF$id == val),] <- x
  }
  else
  {
    DF2[which(computerDF$id == val),] <- computerDF[which(computerDF$id == val),]
  }
}

DF2 <- DF2[!duplicated(DF2$id),]
DF2



```

```{r chart data}

chartdata <- read.csv('../data/visualTestData.csv')

outDF <- merge(DF2, chartdata)

col_order_out <- c("id",
              "csChart",  "csOnline", "csOnlinePrec", "csLab", "csLabPrec", 
                "csOnlineRT", "csLabRT",    
              "vaChart",  "vaOnline", "vaLab" , 
               "vaOnlineRT", "vaLabRT")

   
outDF <- outDF[, col_order_out]

# remove participant 30
outDF <- outDF %>%
  filter(id != 30)

```
save data
```{r save data}
write.csv(outDF, "../data/onlineThresholdsNorway.csv")
```

